class e{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class t{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map}get(){const t=this.normalizeInstanceIdentifier();if(this.instances.has(t))return Promise.resolve(this.instances.get(t));if(!this.instancesDeferred.has(t))if(this.isInitialized(t)||this.shouldAutoInitialize())try{this.getOrInitializeService({instanceIdentifier:t})}catch(e){}else{const n=new e;this.instancesDeferred.set(t,n)}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const n=this.normalizeInstanceIdentifier(),r=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(n)&&!this.shouldAutoInitialize()){if(r)return null;throw Error(`Service ${this.name} is not available.`)}try{const e=this.getOrInitializeService({instanceIdentifier:n});if(e instanceof Promise){if(r)return null;throw Error(`Service ${this.name} is not ready.`)}return e}catch(e){if(r)return null;throw e}}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()&&function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:"[DEFAULT_INSTANCE_NAME]"})}catch(e){}}isComponentSet(){return null!==this.component}isInitialized(e="[DEFAULT_INSTANCE_NAME]"){return this.instances.has(e)}getOrInitializeService({instanceIdentifier:t,options:n={}}){let r=this.instances.get(t),i=this.instancesDeferred.get(t);if(this.component&&!r&&!i){const s=this.component.instanceFactory(this.container,{options:n});s instanceof Promise?(i=i||new e,this.instancesDeferred.set(t,i),s.then((e=>{const n=this.instancesDeferred.get(t);n&&n===i&&(this.instances.set(t,e),this.instancesDeferred.delete(t),n.resolve(e))}),i.reject)):(r=s,this.instances.set(t,r))}return r||(null==i?void 0:i.promise)||null}normalizeInstanceIdentifier(){return"[DEFAULT_INSTANCE_NAME]"}shouldAutoInitialize(){return Boolean(this.component)}}var n,r;(r=n||(n={}))[r.DEBUG=0]="DEBUG",r[r.VERBOSE=1]="VERBOSE",r[r.INFO=2]="INFO",r[r.WARN=3]="WARN",r[r.ERROR=4]="ERROR",r[r.SILENT=5]="SILENT";const i={debug:n.DEBUG,verbose:n.VERBOSE,info:n.INFO,warn:n.WARN,error:n.ERROR,silent:n.SILENT},s=n.INFO,o={[n.DEBUG]:"log",[n.VERBOSE]:"log",[n.INFO]:"info",[n.WARN]:"warn",[n.ERROR]:"error"},a=(e,t,...n)=>{if(t<e.logLevel)return;const r=(new Date).toISOString(),i=o[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)};const c=new Map;class l{constructor(e){this.url=e}getInstanceFactory(){return(t,n)=>{let r=c.get(this.url);return r||(r=new e,c.set(this.url,r),this.initializeRemoteScript(this.url)),r.promise.then((e=>e(t,n)))}}initializeRemoteScript(e){const t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=e;const n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n)}}const h=new class{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const n=new t(e,this);return this.providers.set(e,n),n}}("[DEFAULT_CONTAINER_NAME]"),m=new class{constructor(e){this.name=e,this._logLevel=s,this._logHandler=a}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in n))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?i[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}debug(...e){this._logHandler(this,n.DEBUG,...e)}log(...e){this._logHandler(this,n.VERBOSE,...e)}info(...e){this._logHandler(this,n.INFO,...e)}warn(...e){this._logHandler(this,n.WARN,...e)}error(...e){this._logHandler(this,n.ERROR,...e)}}("app");window.AmoJsSdk=Object.assign(Object.assign({},window.AmoJsSdk||{}),{_registerInstanceFactory:e=>{const t=document.currentScript;if(!(t&&t instanceof HTMLScriptElement))return;const n=t.src,r=c.get(n);r&&r.resolve(e)}});const d=new Map;function u(e){const t=e.name;return d.has(t)?(m.debug(`There were multiple attempts to register component ${t}.`),!1):(d.set(t,e),function(e){try{h.addComponent(e)}catch(t){m.debug(`Component ${e.name} failed to register with ComponentContainer ${h.name}`,t)}}(e),!0)}function f(e){return h.getProvider(e)}class g{constructor(e,t){this.name=e,this.instanceFactory=t,this.instantiationMode="LAZY"}setInstantiationMode(e){return this.instantiationMode=e,this}}class E{constructor(e){this.wscConnectorInnerProvider=e,this.currentWscParams=null,this.iframeElementDeffered=null,this.connectingPromise=null}updateParams(e){this.wscConnectorInnerProvider.get(),this.currentWscParams=e,this.connectingPromise=null,this.iframeElementDeffered=null}getCurrentWscParams(){return this.currentWscParams}async connectIframe(e){if(!this.connectingPromise){const t=new Promise((async n=>{const[r,i]=await Promise.all([this.getIframeElement(),this.wscConnectorInnerProvider.get()]);t===this.connectingPromise&&(r instanceof Error?n(r):e===this.currentWscParams?(await i.initializeIframe(r,e),t===this.connectingPromise&&n()):n(new Error("The Wsc was reinitialized with other params.")))}));this.connectingPromise=t}return this.connectingPromise}async getIframeElement(){if(!this.currentWscParams)return new Error("The Wsc should be initialized before.");if(!this.iframeElementDeffered){const t=new e;this.iframeElementDeffered=t,this.wscConnectorInnerProvider.get().then((e=>e.createIframeElement())).then((e=>{t===this.iframeElementDeffered&&t.resolve(e)}))}return this.iframeElementDeffered.promise}}const w=e=>new E(e.getProvider("wsc-connector-inner"));u(new g("wsc-connector-inner",new l("https://js.amo.tm/v1.3/wsc/connector.js").getInstanceFactory())),u(new g("wsc",w)),(e=>{f("wsc").getImmediate().updateParams(e)})(window.AMO_WSC_PARAMS),(async e=>{const t=f("wsc").getImmediate(),n=t.getCurrentWscParams();if(!n)return void e.onError(new Error("The Wsc should be initialized before mount."));let r=null;if(r=e.container instanceof HTMLElement?e.container:document.querySelector(e.container),!r)return void e.onError(new Error("The container element is not found."));const i=await t.getIframeElement();if(t.getCurrentWscParams()!==n)return;if(i instanceof Error)return void e.onError(i);r.innerHTML="",r.append(i);const s=await t.connectIframe(n);s instanceof Error?e.onError(s):e.onSuccess()})({container:"#amo-subject-container"});
//# sourceMappingURL=index.f0382c42.js.map
